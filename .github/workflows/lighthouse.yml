name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop, '**-harden-**']
  push:
    branches: ['**-harden-**']
  workflow_dispatch:

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse-desktop:
    name: Lighthouse (Desktop)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ’¡ Run Lighthouse CI (Desktop)
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=lighthouserc.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ğŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-desktop-results
          path: .lighthouseci
          retention-days: 30

  lighthouse-mobile:
    name: Lighthouse (Mobile)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ’¡ Run Lighthouse CI (Mobile)
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=lighthouserc.mobile.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ğŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-mobile-results
          path: .lighthouseci
          retention-days: 30

  lighthouse-comment:
    name: Comment PR with Lighthouse Results
    runs-on: ubuntu-latest
    needs: [lighthouse-desktop, lighthouse-mobile]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Download desktop results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-desktop-results
          path: ./lighthouse-desktop
      
      - name: ğŸ“¥ Download mobile results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-mobile-results
          path: ./lighthouse-mobile
      
      - name: ğŸ’¬ Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read results (simplified - actual implementation would parse JSON)
            const desktopPassed = fs.existsSync('./lighthouse-desktop');
            const mobilePassed = fs.existsSync('./lighthouse-mobile');
            
            const comment = `## ğŸ’¡ Lighthouse CI Results
            
            ### Desktop
            ${desktopPassed ? 'âœ… Passed' : 'âŒ Failed'}
            
            ### Mobile
            ${mobilePassed ? 'âœ… Passed' : 'âŒ Failed'}
            
            **Performance Budgets:**
            - LCP < 2.0s (desktop), < 2.5s (mobile)
            - FID < 100ms
            - CLS < 0.1
            - TTI < 3.0s
            - JS Bundle < 200KB (gzipped)
            
            See artifacts for detailed reports.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
