name: Lighthouse CI

on:
  pull_request:
    branches: [main, develop, '**-harden-**']
    paths:
      - 'src/app/(storefront)/**'
      - 'src/app/(dashboard)/**'
      - 'src/app/api/**'
      - 'src/components/**'
      - 'src/app/layout.tsx'
      - 'src/app/page.tsx'
      - 'public/**'
      - 'lighthouserc*.js'
      - '.github/workflows/lighthouse.yml'
  push:
    branches: ['**-harden-**']
    paths:
      - 'src/app/(storefront)/**'
      - 'src/app/(dashboard)/**'
      - 'src/app/api/**'
      - 'src/components/**'
      - 'src/app/layout.tsx'
      - 'src/app/page.tsx'
      - 'public/**'
      - 'lighthouserc*.js'
      - '.github/workflows/lighthouse.yml'
  workflow_dispatch:

concurrency:
  group: lighthouse-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse-desktop:
    name: Lighthouse (Desktop)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ’¡ Run Lighthouse CI (Desktop)
        id: lhci-desktop
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=lighthouserc.js || exit 1
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ğŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-desktop-results
          path: .lighthouseci
          retention-days: 30
      
      - name: âŒ Fail if budgets breached
        if: failure()
        run: |
          echo "::error::âŒ Lighthouse CI FAILED (Desktop) - Performance budgets breached"
          echo "::error::Constitution budgets: LCP < 2.0s, CLS < 0.1, FID < 100ms, TTI < 3.0s"
          echo "::error::Performance score â‰¥ 90, Accessibility â‰¥ 90, Bundle < 200KB"
          echo "::error::See artifacts for detailed reports"
          exit 1

  lighthouse-mobile:
    name: Lighthouse (Mobile)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ’¡ Run Lighthouse CI (Mobile)
        id: lhci-mobile
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --config=lighthouserc.mobile.js || exit 1
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      
      - name: ğŸ“Š Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-mobile-results
          path: .lighthouseci
          retention-days: 30
      
      - name: âŒ Fail if budgets breached
        if: failure()
        run: |
          echo "::error::âŒ Lighthouse CI FAILED (Mobile) - Performance budgets breached"
          echo "::error::Constitution budgets: LCP < 2.5s, CLS < 0.1, FID < 100ms, TTI < 3.0s"
          echo "::error::Performance score â‰¥ 90, Accessibility â‰¥ 90, Bundle < 200KB"
          echo "::error::See artifacts for detailed reports"
          exit 1

  lighthouse-comment:
    name: Comment PR with Lighthouse Results
    runs-on: ubuntu-latest
    needs: [lighthouse-desktop, lighthouse-mobile]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Download desktop results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lighthouse-desktop-results
          path: ./lighthouse-desktop
      
      - name: ğŸ“¥ Download mobile results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: lighthouse-mobile-results
          path: ./lighthouse-mobile
      
      - name: ğŸ’¬ Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check job statuses
            const desktopPassed = '${{ needs.lighthouse-desktop.result }}' === 'success';
            const mobilePassed = '${{ needs.lighthouse-mobile.result }}' === 'success';
            
            const overallStatus = desktopPassed && mobilePassed ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = desktopPassed && mobilePassed ? 'âœ…' : 'âŒ';
            
            const comment = `## ğŸ’¡ Lighthouse CI Results - ${overallStatus}
            
            ### Desktop ${desktopPassed ? 'âœ…' : 'âŒ'}
            **Performance Budgets** (Constitution Â§128-134):
            - âœ“ LCP (Largest Contentful Paint): < 2.0s
            - âœ“ FID (First Input Delay): < 100ms
            - âœ“ CLS (Cumulative Layout Shift): < 0.1
            - âœ“ TTI (Time to Interactive): < 3.0s
            - âœ“ TBT (Total Blocking Time): < 300ms
            - âœ“ JavaScript Bundle: < 200KB (gzipped)
            - âœ“ Performance Score: â‰¥ 90
            - âœ“ Accessibility Score: â‰¥ 90
            
            ${desktopPassed ? 'âœ… All budgets passed' : 'âŒ **BLOCKING**: Budgets breached - see artifacts for details'}
            
            ### Mobile ${mobilePassed ? 'âœ…' : 'âŒ'}
            **Performance Budgets**:
            - âœ“ LCP (Largest Contentful Paint): < 2.5s
            - âœ“ FID (First Input Delay): < 100ms
            - âœ“ CLS (Cumulative Layout Shift): < 0.1
            - âœ“ TTI (Time to Interactive): < 3.0s
            - âœ“ TBT (Total Blocking Time): < 300ms
            - âœ“ JavaScript Bundle: < 200KB (gzipped)
            - âœ“ Performance Score: â‰¥ 90
            - âœ“ Accessibility Score: â‰¥ 90
            
            ${mobilePassed ? 'âœ… All budgets passed' : 'âŒ **BLOCKING**: Budgets breached - see artifacts for details'}
            
            ---
            
            ${emoji} **${overallStatus}** - ${desktopPassed && mobilePassed ? 'Merge allowed' : '**MERGE BLOCKED** - Fix performance/accessibility issues before merging'}
            
            ğŸ“Š Download artifacts for detailed Lighthouse reports.
            
            **Constitution Reference**: Performance requirements in Â§118-134, Â§177-195
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
