name: k6 Load Tests

on:
  pull_request:
    branches: [main, develop, '**-harden-**']
    paths:
      - 'src/app/api/checkout/**'
      - 'src/app/api/orders/**'
      - 'src/services/checkout-service.ts'
      - 'src/services/pricing-service.ts'
      - 'src/services/export-service.ts'
      - 'src/services/payment-service.ts'
      - 'tests/performance/**'
      - '.github/workflows/k6-load-tests.yml'
  push:
    branches: ['**-harden-**']
    paths:
      - 'src/app/api/checkout/**'
      - 'src/app/api/orders/**'
      - 'src/services/checkout-service.ts'
      - 'src/services/pricing-service.ts'
      - 'src/services/export-service.ts'
      - 'src/services/payment-service.ts'
      - 'tests/performance/**'
      - '.github/workflows/k6-load-tests.yml'
  workflow_dispatch:
  schedule:
    # Run load tests daily at 2 AM UTC
    - cron: '0 2 * * *'

concurrency:
  group: k6-${{ github.ref }}
  cancel-in-progress: true

jobs:
  k6-checkout:
    name: k6 Load Test - Checkout Flow
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_TEST_SECRET_KEY }}" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ”§ Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: ğŸš€ Run k6 Load Test - Checkout
        id: k6-checkout-run
        run: k6 run tests/performance/checkout-load-test.js
        env:
          K6_OUT: json=checkout-results.json
      
      - name: ğŸ“Š Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-checkout-results
          path: checkout-results.json
          retention-days: 30
      
      - name: âŒ Fail if thresholds breached
        if: failure()
        run: |
          echo "::error::âŒ k6 load test FAILED - Thresholds breached for checkout flow"
          echo "::error::Thresholds: API p95 < 500ms, Checkout p95 < 650ms, Error rate < 1%, Success rate > 99%"
          echo "::error::See artifacts for detailed metrics"
          exit 1

  k6-export:
    name: k6 Load Test - Orders Export
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—„ï¸ Setup test database with large dataset
        run: |
          cp .env.example .env
          echo "DATABASE_URL=file:./prisma/test.db" >> .env
          echo "NEXTAUTH_SECRET=test-secret-min-32-chars-long-for-testing" >> .env
          echo "NEXTAUTH_URL=http://localhost:3000" >> .env
          npx prisma generate
          npx prisma db push --force-reset
          npx prisma db seed
          # Seed additional orders for export testing (15k+ orders)
          node -e "require('./prisma/seed').seedLargeOrderSet()"
      
      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: ğŸš€ Start application
        run: npm run start &
        env:
          NODE_ENV: production
      
      - name: â³ Wait for application
        run: npx wait-on http://localhost:3000 -t 60000
      
      - name: ğŸ”§ Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: ğŸš€ Run k6 Load Test - Export
        id: k6-export-run
        run: k6 run tests/performance/orders-export-load-test.js
        env:
          K6_OUT: json=export-results.json
      
      - name: ğŸ“Š Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-export-results
          path: export-results.json
          retention-days: 30
      
      - name: âŒ Fail if thresholds breached
        if: failure()
        run: |
          echo "::error::âŒ k6 load test FAILED - Thresholds breached for orders export"
          echo "::error::Thresholds: Streaming p95 < 5s, Async enqueue p95 < 500ms, Error rate < 2%, Success rate > 98%"
          echo "::error::See artifacts for detailed metrics"
          exit 1

  k6-comment:
    name: Comment PR with k6 Results
    runs-on: ubuntu-latest
    needs: [k6-checkout, k6-export]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Download checkout results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: k6-checkout-results
          path: ./k6-checkout
      
      - name: ğŸ“¥ Download export results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: k6-export-results
          path: ./k6-export
      
      - name: ğŸ’¬ Comment PR with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Check job statuses
            const checkoutPassed = '${{ needs.k6-checkout.result }}' === 'success';
            const exportPassed = '${{ needs.k6-export.result }}' === 'success';
            
            const overallStatus = checkoutPassed && exportPassed ? 'âœ… PASSED' : 'âŒ FAILED';
            const emoji = checkoutPassed && exportPassed ? 'âœ…' : 'âŒ';
            
            const comment = `## ğŸš€ k6 Load Test Results - ${overallStatus}
            
            ### Checkout Flow (50 VUs, 2 min) ${checkoutPassed ? 'âœ…' : 'âŒ'}
            **Thresholds** (Constitution Â§118-120):
            - âœ“ API Response (p95): < 500ms
            - âœ“ Checkout Complete (p95): < 650ms  
            - âœ“ Error Rate: < 1%
            - âœ“ Success Rate: > 99%
            
            ${checkoutPassed ? 'âœ… All thresholds passed' : 'âŒ **BLOCKING**: Thresholds breached - see artifacts for details'}
            
            ### Orders Export (20 VUs, 1.5 min) ${exportPassed ? 'âœ…' : 'âŒ'}
            **Thresholds**:
            - âœ“ Streaming Export (p95): < 5s
            - âœ“ Async Enqueue (p95): < 500ms
            - âœ“ Error Rate: < 2%
            - âœ“ Success Rate: > 98%
            
            ${exportPassed ? 'âœ… All thresholds passed' : 'âŒ **BLOCKING**: Thresholds breached - see artifacts for details'}
            
            ---
            
            ${emoji} **${overallStatus}** - ${checkoutPassed && exportPassed ? 'Merge allowed' : '**MERGE BLOCKED** - Fix performance issues before merging'}
            
            ğŸ“Š Download artifacts for detailed metrics and timings.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
