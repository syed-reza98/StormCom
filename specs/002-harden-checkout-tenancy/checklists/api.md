<!--
  Checklist: API Requirements Quality
  Generated by speckit.checklist on 2025-11-14
  Purpose: Unit-tests-for-English that validate the API & backend requirements' clarity, completeness, consistency, measurability and traceability
-->

# API Requirements Quality Checklist

Purpose: Validate that API-related requirements in `specs/002-harden-checkout-tenancy` are complete, unambiguous, measurable, and traceable before implementation.

Feature: Harden Checkout, Tenancy, and Newsletter
Created: 2025-11-14
Author: automated speckit.checklist run

Notes: This checklist tests the *requirements text* (not the implementation). Each item references the spec where relevant (e.g., FR identifiers). If a requirement is missing or ambiguous, mark the item and update spec/plan/tasks accordingly.

## Requirement Completeness
- [X] CHK001 - Are authentication requirements for checkout fully specified, including which endpoints require a session and exact auth failure responses? [Completeness, Spec §FR-001]
  - ✅ PASS: FR-001 requires valid signed-in session; contracts/openapi.yaml defines 401 Unauthorized response; tasks T1.1 specifies getServerSession() usage
- [X] CHK002 - Is the server-side pricing recalculation scope fully enumerated (line items, discounts, shipping, taxes, rounding rules, currency behavior)? [Completeness, Spec §FR-002]
  - ✅ PASS: FR-002 explicitly lists "all line items, discounts, shipping, and taxes"; data-model.md shows Order.totals structure; tasks T1.2 references validateCart and total calculation
- [X] CHK003 - Are all API endpoints that must include `X-Request-Id` and correlation propagation identified in the spec/plan? [Completeness, Spec §FR-021]
  - ✅ PASS: FR-021 mandates unique request/correlation ID in all API responses; plan T0.1-T0.2 creates request-context.ts; tasks T4.2 adds requestId seeding in proxy
- [X] CHK004 - Are CSV export behaviors fully specified (stream threshold, async enqueue conditions, notification channels) and linked to an export failure/retry policy? [Completeness, Spec §FR-016]
  - ✅ PASS: FR-016 specifies ≤10k rows streaming with memory/time caps, >10k async job with email + in-app notification; clarifications specify 200MB heap/120s timeout; contracts/openapi.yaml shows 200 vs 202 responses

## Requirement Clarity
- [X] CHK005 - Is the payment pre-validation requirement precise about what constitutes a valid intent/token (authorization vs capture) and when validation occurs? [Clarity, Spec §FR-003]
  - ✅ PASS: FR-003 clarification states "verify payment intent exists, amount/currency match server totals, accept AUTHORIZED states for later capture, document which states are validated vs captured"; clarifications add idempotency key handling and retry semantics
- [X] CHK006 - Are error response shapes and HTTP status mappings explicitly defined for common failures (validation, auth, rate-limit, conflict, internal)? [Clarity, Spec §FR-008]
  - ✅ PASS: FR-008 standardizes success `{data, meta?, message?}` and error `{error: {code, message, details?}}`; contracts/openapi.yaml defines 400/401/409/429/500 responses with Error schema; plan T0.3 creates error class hierarchy with httpStatus
- [X] CHK007 - Is the canonical redirect behavior specified with HTTP status code, canonical link header conventions, and SEO considerations (308 vs 301, rel=canonical)? [Clarity, Spec §FR-005]
  - ✅ PASS: FR-005 clarification specifies HTTP 301 for GET requests with `Link: <https://{primary-domain}{path}>; rel="canonical"` header; for non-GET returns 4xx with explanatory body; tasks T2.1 implements in proxy.ts
- [X] CHK008 - Are rate-limiting thresholds for newsletter and checkout clearly quantified (requests/min per IP/store) and behavior on exceed (Retry-After header) defined? [Clarity, Spec §FR-019, assumption in spec]
  - ✅ PASS: Assumptions section states "100 requests per minute per IP"; contracts/openapi.yaml shows 429 RateLimited response; tasks T3.1 calls simple limiter (100 rpm/IP); constitution references rate-limit.ts implementation

## Requirement Consistency
- [X] CHK009 - Do authentication requirements align across spec/plan/tasks (no conflicting statements about anonymous checkout or default store fallbacks)? [Consistency, Spec §FR-001/FR-006]
  - ✅ PASS: spec.md FR-001 requires "valid signed-in session" with no anonymous fallback mentioned; plan.md P1 enforces auth via getServerSession(); tasks.md T1.1 implements auth-helpers.ts; FR-006 cache revalidation requires auth context - no contradictions found
- [X] CHK010 - Are tenant-scoping semantics consistently described (session.storeId vs domain-resolver) and not contradictory across plan and tasks? [Consistency, Spec §FR-005/FR-009]
  - ✅ PASS: spec.md FR-005 uses session.storeId for tenant isolation; FR-009 domain-resolver maps custom domains to storeId; plan.md P1/P2 creates store-resolver.ts for both flows; tasks.md T2.2 wires middleware - no contradictions, both mechanisms feed same storeId
- [X] CHK011 - Are the cache invalidation semantics (tags and revalidateTag signature) consistently used in plan and tasks (e.g., `revalidateTag(tag, 'max')`)? [Consistency, Plan P5]
  - ✅ PASS: spec.md FR-006 requires explicit cache invalidation; plan.md P5 T5.1 creates cache-tags.ts with tag registry and revalidateTag(tag, 'max') signature per Next.js 16; tasks.md T5.1 shows implementation file; clarifications confirm 'max' cacheLife profile usage

## Acceptance Criteria Quality
- [X] CHK012 - Are acceptance criteria measurable and tied to concrete checks (e.g., SC-003 specifies server-side recalculation validated by E2E across browsers)? [Measurability, Spec Success Criteria SC-003]
  - ✅ PASS: SC-003 states "server-side total recalculation occurs for 100% of checkouts with E2E test validating across Chrome/Firefox/Safari"; SC-007 requires "100% API conformity to standardized response shapes with X-Request-Id header"; all SC items include concrete verification methods
- [X] CHK013 - Do success criteria include pass/fail thresholds for non-functional requirements (LCP/CLS/API p95) with explicit measurement contexts? [Measurability, Spec SC-010]
  - ✅ PASS: SC-010 specifies "LCP < 2.0s (desktop) and < 2.5s (mobile), CLS < 0.1, FID < 100ms, API p95 < 500ms"; SC-010a adds "DB query p95 < 100ms, JS bundle < 200KB gzipped"; all thresholds are quantified with measurement contexts (desktop/mobile, percentiles)
- [X] CHK014 - Are rollback/compensation criteria specified for partial failures during checkout (what exact DB state indicates need for cleanup/reversal)? [Measurability, Spec §FR-010/FR-012]
  - ✅ PASS: FR-010 specifies atomic transaction pattern "if payment capture fails, roll back entire order creation"; FR-012 requires idempotency checks to prevent duplicate orders; plan.md P2 details transaction semantics with db.$transaction() and payment validation adapter; tasks T1.4 implements compensation logic